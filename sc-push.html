<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE
The complete set of authors may be found at http://polymer.github.io/AUTHORS
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS
-->
<link rel="import" href="../polymer/polymer.html" />

<script>
(function () {

  window.Polymer({
    is: 'sc-push',

    properties: {

      /**
       * A string that is used for GCM registration on Android
       *
       * @default '1076345567071'
       */
      gcmSenderId: {
        type: String,
        value: '1076345567071' // Parse.com default GCM Sender ID
      },

      /**
       * A string that is used for the name of the android notification icon
       * (android/res/drawable/{icon}.png)
       *
       * @default ''
       */
      icon: {
        type: String,
        value: ''
      },

      /**
       * A string that is used for the background color of the android notification icon
       *
       * @default ''
       */
      iconColor: {
        type: String,
        value: ''
      },

      /**
       * A boolean to enable logs to be written to `console.log`
       *
       * @default false
       */
      debug: {
        type: Boolean,
        value: false
      },

      /**
       * A string that contains the registrationId/deviceId after successful registration
       *
       * @default '1076345567071'
       */
      registrationId: {
        type: String,
        value: undefined,
        notify: true
      },

      /**
       * A string that contains the state of: 'init|success|error'
       *
       * @default 'init'
       */
      state: {
        type: String,
        value: 'init'
      }

    },

    log: function () {
      return this.debug && window.console.log.apply(window.console, arguments);
    },

    init: function () {
      if (!window.PushNotification) {
        this._fails = (this._fails || 0) + 1;
        if (this._fails > 10) {
          this._fails = 0;
          return;
        }

        return setTimeout(this.init.bind(this), 1000);
      }

      var config = {
        android: {
          senderID: this.gcmSenderId
        },
        ios: {
          alert: true,
          badge: true,
          sound: true
        },
        windows: {}
      };

      if (this.icon) {
        config.android.icon = this.icon;
      }

      if (this.icon) {
        config.android.iconColor = this.iconColor;
      }

      this._push = window.PushNotification && window.PushNotification.init(config);

      this._push.on('registration', this.onRegistration.bind(this));

      this._push.on('notification', this.onNotification.bind(this));

      this._push.on('error', this.onError.bind(this));
    },

    onRegistration: function (e) {
      this.set('state', 'success');
      this.log('Successfully registered for push notifications', e);
      this.fire('registration', e, { bubbles: false });

      if (e.registrationId) {
        this.set('registrationId', e.registrationId);
      }
    },

    onNotification: function (e) {
      this.log('Push notification received', e);
      this.fire('notification', e, { bubbles: false });
    },

    onError: function (e) {
      this.set('state', 'error');
      this.log(e.message);
      this.fire('error', e, { bubbles: false });
    },

    unregister: function () {
      var success = this.log.bind(this, 'Successfully unregistered for push notifications');
      var error = this.log.bind(this, 'Error while unregistering for push notifications');

      this.set('registrationId', undefined);
      this.set('state', 'init');

      return this._push && this._push.unregister(success, error);
    },

    setApplicationIconBadgeNumber: function (count) {
      var success = this.log.bind(this, 'Successfully set icon badge');

      return this._push && this._push.setApplicationIconBadgeNumber(success, function () {}, count);
    },

    getApplicationIconBadgeNumber: function (success) {
      if (!this._push) {
        return success(0);
      }

      return this._push.getApplicationIconBadgeNumber(success, function () {});
    },

    clearApplicationIconBadgeNumber: function () {
      return this.setApplicationIconBadgeNumber(0);
    }

  });

})();
</script>
